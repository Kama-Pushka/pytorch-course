# Прогнозирование кардиомегалии с помощью сверточной нейросети (CNN)

Данный учебный проект представляет собой модель машинного обучения на основе предобученной модели EfficientNet-B3. 

### Датасет

[Cardiomegaly Disease Prediction Using CNN](https://www.kaggle.com/datasets/rahimanshu/cardiomegaly-disease-prediction-using-cnn)

Датасет представляет собой >4000 рентген-снимков грудной клетки с пометками, присутствует ли на них кардиомегалия - аномальное увеличение сердца. Размер всех изображений составляет 128x128 px.

![dataset.png](plots%2Fdataset.png)

### Модель

[models.py](models.py)

Для обучения была взята предобученная модель EfficientNet B3 из пакета efficientnet_pytorch. К модели были добавлены слои нормализации (BatchNorm), регуляризации (Dropout), функции активации (Relu и Softmax) и линейные слои (Linear) дабы привести выход к определению вероятности двух классов.
Также во время обучения используется глобальный max pooling, дабы сократить объем информации о изображениях.

Представление модели:

```commandline
=========================================================================================================
CardiomegalyClassifier                                  [9, 2]                    --
├─EfficientNet: 1-1                                     --                        1,537,000
├─Sequential: 1-2                                       [9, 2]                    --
│    └─BatchNorm1d: 2-8                                 [9, 1536]                 3,072
│    └─Linear: 2-9                                      [9, 256]                  393,472
│    └─ReLU: 2-10                                       [9, 256]                  --
│    └─Dropout: 2-11                                    [9, 256]                  --
│    └─Linear: 2-12                                     [9, 2]                    514
│    └─LogSoftmax: 2-13                                 [9, 2]                    --
=========================================================================================================
```

### Обработка данных

[datasets.py](datasets.py)

Для получения и обработки данных написан кастомный датасет `CardiomegalyDataset`, который принимает путь до подвыборки (train или test), записывает пути до изображений и запоминает их класс. 
При вызове каждого следующего изображения происходит трансформация изображения через  `EfficientNet_B3_Weights.IMAGENET1K_V1.transforms()`
Стандартный размер батчей - 16.

### Обучение

[trainer.py](trainer.py)

Код обучения разделён на две составляющие: 

Функция `train_model()`, принимающая модель, обучающую и тестовую выборки, количество эпох, скорость обучения, оптимизатор и устройство (CUDA/CPU).
По стандарту используется оптимизатор `Adamax(lr=lr, weight_decay=0.005)`. Функцией потерь выступает `CrossEntropyLoss`. В методе запускаются эпохи для train и test выборок (функция `run_epoch()`), записываются метрики (loss, accuracy), лучшая модель сохраняется в папку `params/`.

Функция `run_epoch()` отвечает за обучение на одной эпохе. Возвращаются полученные метрики потерь и точности.

### Визуализация 

[utils.py](utils.py)

Написаны дополнительные функции визуализации преобразованных изображений, графика обучения (кривые потерь и точности) и Confusion Matrix.

Обучение модели можно запустить в [main.py](main.py), автоматически загрузить датасет - [kaggle-data.py](kaggle-data.py)

# Результаты

![b3.png](plots%2Fb3.png)
![b3_cm.png](plots%2Fb3_cm.png)

Из графиков видно, что модель сумела достичь точности в 80% на тестовой выборке, однако дальше началось переобучение. 

Дополнительно обучены модели EfficientNet-B4 и EfficientNet-B7 для сверки результатов.

![b4.png](plots%2Fb4.png)
![b7.png](plots%2Fb7.png)

Как можно заметить, модели также страдают от переобучения и зафиксировались на точности в 80%. 
Такое поведение может быть вызвано как ошибками при проектировании модели, так и некачественным датасетом или обработки его.

Для теста была написана аналогичная модель на Tensorflow с использованием сходных параметров. Описание сравнения обучения можно найти в [pytorch_vs_tensorflow_models.ipynb](pytorch_vs_tensorflow_models.ipynb)

Из метрик при обучении видно, что Tensorflow модель достигает точности 99% на тестовой выборке, из чего можно сделать вывод, что были допущены ошибки при проектировании архитектуры или обучения PyTorch модели.